<?xml version="1.0" encoding="UTF-8"?>
<sequence name="main_kafka_to_gcs_seq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log category="INFO" logMessageID="false" logFullPayload="false">
        <message>Receive cache event</message>
        <property name="PartitionNo" expression="get-property('partitionNo')"/>
        <property name="Offset" expression="get-property('offset')"/>
        <property name="Event Id" expression="get-property('eventId')"/>
        <property name="Event Action" expression="get-property('action')"/>
        <property name="Event Type" expression="get-property('type')"/>
        <property name="Topic" expression="get-property('topic')"/>
        <property name="Partition" expression="get-property('partition')"/>
        <property name="Tenant" expression="get-property('tenantId')"/>
    </log>
    <filter description="No partition" regex="false" source="boolean(get-property('partition'))">
        <then>
            <log category="INFO" logMessageID="false" logFullPayload="false">
                <message>Missing message header partition. So, set to partition &quot;default&quot;</message>
            </log>
            <property name="partition" scope="default" type="STRING" value="default"/>
        </then>
        <else/>
    </filter>
    <filter description="No Tenant" regex="false" source="boolean(get-property('tenantId'))">
        <then>
            <log category="INFO" logMessageID="false" logFullPayload="false">
                <message>There is no tenantId header, so add default tenant [${configs.kafka_to_gcs_default_tenant_id}]</message>
            </log>
            <property name="tenantId" scope="default" type="STRING" expression="${configs.kafka_to_gcs_default_tenant_id}"/>
        </then>
        <else>
        </else>
    </filter>
    <switch description="Action" source="get-property('action')">
        <case regex="CREATED">
            <propertyGroup>
                <property name="bucket" scope="default" type="STRING" expression="${configs.kafka_to_gcs_bucket}" action="set"/>
                <property name="objectKey" scope="default" type="STRING" expression="fn:concat(get-property('tenantId'),'/',get-property('topic'),'/',get-property('type'),'/',get-property('partition'),'/',get-property('eventId'),'.json')"/>
                <property name="contentType" scope="default" type="STRING" value="application/json"/>
                <property name="content" scope="default" type="JSON" expression="json-eval($.)"/>
            </propertyGroup>
            <sequence key="put_object_gcs"/>
        </case>
        <case regex="MODIFIED">
            <propertyGroup>
                <property name="bucket" scope="default" type="STRING" expression="${configs.kafka_to_gcs_bucket}" action="set"/>
                <property name="objectKey" scope="default" type="STRING" expression="fn:concat(get-property('tenantId'),'/',get-property('topic'),'/',get-property('type'),'/',get-property('partition'),'/',get-property('eventId'),'.json')"/>
                <property name="contentType" scope="default" type="STRING" value="application/json"/>
                <property name="content" scope="default" type="JSON" expression="json-eval($.)"/>
            </propertyGroup>
            <sequence key="put_object_gcs"/>
        </case>
        <case regex="DELETE">
            <propertyGroup>
                <property name="bucket" scope="default" type="STRING" expression="${configs.kafka_to_gcs_bucket}" action="set"/>
                <property name="objectKey" scope="default" type="STRING" expression="fn:concat(get-property('tenantId'),'/',get-property('topic'),'/',get-property('type'),'/',get-property('partition'),'/',get-property('eventId'),'.json')"/>
                <property name="contentType" scope="default" type="STRING" value="application/json"/>
                <property name="content" scope="default" type="JSON" expression="json-eval($.)"/>
            </propertyGroup>
            <sequence key="delete_object_gcs"/>
        </case>
        <case regex="EXPIRED">
            <propertyGroup>
                <property name="bucket" scope="default" type="STRING" expression="${configs.kafka_to_gcs_bucket}" action="set"/>
                <property name="objectKey" scope="default" type="STRING" expression="fn:concat(get-property('tenantId'),'/',get-property('topic'),'/',get-property('type'),'/',get-property('partition'),'/',get-property('eventId'),'.json')"/>
                <property name="contentType" scope="default" type="STRING" value="application/json"/>
                <property name="content" scope="default" type="JSON" expression="json-eval($.)"/>
            </propertyGroup>
            <log category="INFO" logMessageID="false" logFullPayload="false">
                <message>GCS Syncer ignores EXPIRED event</message>
            </log>
        </case>
        <default>
            <log category="INFO" logMessageID="false" logFullPayload="false">
                <message>GCS ignores event WITHOUT action</message>
            </log>
        </default>
    </switch>
</sequence>
